// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// =====================
/// Authentication & Audit
/// =====================

enum Role {
  EMPLOYEE
  MANAGER
  ADMIN
}

enum AuditAction {
  OTP_SENT
  OTP_VERIFY_SUCCESS
  OTP_VERIFY_FAIL
  LOGIN_SUCCESS
  LOGOUT
  SESSION_REFRESH
  DEVICE_TRUST_CREATED
  DEVICE_TRUST_REVOKED
  ROLE_UPDATED
}

model User {
  id         String   @id @default(cuid())
  phoneE164  String   @unique
  role       Role     @default(EMPLOYEE)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sessions   Session[]
  devices    TrustedDevice[]
  auditLogs  AuditLog[]

  @@index([role])
  @@map("users")
}

model Session {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  revokedAt  DateTime?
  userAgent  String?
  ip         String?

  @@index([userId])
  @@index([expiresAt])
  @@map("sessions")
}

model TrustedDevice {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  deviceIdHash String
  userAgent    String?
  ipFirstUsed  String?
  createdAt    DateTime @default(now())
  lastSeenAt   DateTime @default(now())
  expiresAt    DateTime
  revokedAt    DateTime?

  @@unique([userId, deviceIdHash])
  @@index([expiresAt])
  @@map("trusted_devices")
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  user      User?       @relation(fields: [userId], references: [id])
  phone     String?
  action    AuditAction
  ip        String?
  userAgent String?
  metadata  Json?
  createdAt DateTime    @default(now())

  @@index([createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

model OtpAttempt {
  id         String   @id @default(cuid())
  phoneE164  String
  ip         String?
  createdAt  DateTime @default(now())

  @@index([phoneE164, createdAt])
  @@index([ip, createdAt])
  @@map("otp_attempts")
}

model ProductionOrder {
  id                       String         @id @default(cuid())
  customerName             String // å®¢æˆ¶åç¨±
  productName              String         @default("æœªå‘½åç”¢å“") // ç”¢å“åå­—
  productionQuantity       Int // ç”Ÿç”¢æ•¸é‡
  unitWeightMg             Float // å–®ç²’ç¸½é‡é‡ï¼ˆè¨ˆç®—ï¼‰
  batchTotalWeightMg       Float // æ‰¹æ¬¡ç¸½é‡é‡ï¼ˆè¨ˆç®—ï¼‰
  completionDate           DateTime? // å®Œå·¥æ—¥æœŸ
  processIssues            String? // è£½ç¨‹å•é¡Œè¨˜éŒ„
  qualityNotes             String? // å“ç®¡å‚™è¨»
  capsuleColor             String? // è† å›Šé¡è‰²
  capsuleSize              String? // è† å›Šå¤§å° (#1, #0, #00)
  capsuleType              String? // è† å›Šæˆä»½ (æ˜è† èƒƒæº¶, æ¤ç‰©èƒƒæº¶, æ˜è† è…¸æº¶, æ¤ç‰©è…¸æº¶)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  customerService          String? // å®¢æœå§“å
  actualProductionQuantity Int? // å¯¦éš›ç”Ÿç”¢å®Œæˆæ•¸é‡ï¼ˆç²’ï¼‰
  materialYieldQuantity    Int? // ææ–™å¯¦éš›å¯åšæ•¸é‡ï¼ˆç²’ï¼‰
  lockPassword             String? // 4 ä½æ•¸å¯†ç¢¼ä¿è­·ï¼ˆnullableï¼‰
  ingredients              Ingredient[]
  worklogs                 OrderWorklog[]

  @@index([completionDate, createdAt])
  @@map("production_orders")
}

model Ingredient {
  id                 String          @id @default(cuid())
  orderId            String
  materialName       String // åŸæ–™å“å
  unitContentMg      Float // å–®ç²’å«é‡
  isCustomerProvided Boolean         @default(true) // æ˜¯å¦å®¢æˆ¶æŒ‡å®š
  isCustomerSupplied Boolean         @default(true) // æ˜¯å¦å®¢æˆ¶æä¾›
  order              ProductionOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([materialName])
  @@map("ingredients")
}

model OrderWorklog {
  id                  String   @id @default(cuid())
  orderId             String
  workDate            DateTime
  headcount           Int
  startTime           String   @db.VarChar(5)
  endTime             String   @db.VarChar(5)
  notes               String?
  effectiveMinutes    Int
  calculatedWorkUnits Float
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  order ProductionOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, workDate])
  @@index([workDate, createdAt])
  @@map("order_worklogs")
}

// ===== v2.0 æ–°å¢æ¨¡å‹ =====

model AIRecipe {
  id               String   @id @default(cuid())
  name             String // é…æ–¹åç¨±
  description      String? // é…æ–¹æè¿°
  targetEffect     String // ç›®æ¨™åŠŸæ•ˆ
  targetAudience   String? // ç›®æ¨™å—çœ¾
  dosageForm       String   @default("capsule") // åŠ‘å‹ (capsule, tablet, powder)
  ingredients      String   @db.Text // åŸæ–™åˆ—è¡¨ (JSON as String)
  dosage           String   @db.Text // åŠ‘é‡ä¿¡æ¯ (JSON as String)
  efficacyScore    Float? // åŠŸæ•ˆè©•åˆ† (0-10)
  safetyScore      Float? // å®‰å…¨æ€§è©•åˆ† (0-10)
  costAnalysis     String?  @db.Text // æˆæœ¬åˆ†æ (JSON as String)
  regulatoryStatus String? // æ³•è¦ç‹€æ…‹
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([name])
  @@index([isActive, createdAt])
  @@index([targetEffect])
  @@map("ai_recipes")
}

model IngredientPrice {
  id           String    @id @default(cuid())
  materialName String // åŸæ–™åç¨±
  supplier     String // ä¾›æ‡‰å•†
  price        Float // åƒ¹æ ¼
  currency     String    @default("HKD") // è²¨å¹£
  unit         String    @default("kg") // å–®ä½
  minimumOrder Float? // æœ€å°è¨‚è³¼é‡
  leadTime     String? // äº¤è²¨æœŸ
  quality      String    @default("A") // è³ªé‡ç­‰ç´š (A, B, C)
  source       String? // æ•¸æ“šä¾†æº
  validFrom    DateTime  @default(now()) // æœ‰æ•ˆæœŸé–‹å§‹
  validTo      DateTime? // æœ‰æ•ˆæœŸçµæŸ
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([materialName, supplier])
  @@index([validFrom, validTo])
  @@index([quality])
  @@map("ingredient_prices")
}

model ProductEfficacy {
  id                String   @id @default(cuid())
  ingredientName    String // åŸæ–™åç¨±
  effect            String // åŠŸæ•ˆ
  evidenceLevel     String // è­‰æ“šç­‰ç´š (A, B, C, D)
  dosage            Float // åŠ‘é‡
  scientificBasis   String?  @db.Text // ç§‘å­¸ä¾æ“š
  clinicalTrials    String?  @db.Text // è‡¨åºŠè©¦é©—æ•¸æ“š (JSON as String)
  safetyProfile     String?  @db.Text // å®‰å…¨æ€§æª”æ¡ˆ (JSON as String)
  interactions      String?  @db.Text // ç›¸äº’ä½œç”¨ (JSON as String)
  contraindications String?  @db.Text // ç¦å¿Œç—‡ (JSON as String)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([ingredientName, effect])
  @@index([evidenceLevel])
  @@index([isActive])
  @@map("product_efficacy")
}

model WorkOrder {
  id                   String    @id @default(cuid())
  orderId              String // é—œè¯çš„è¨‚å–®ID
  orderNumber          String    @unique // å·¥ä½œå–®è™Ÿ
  productName          String // ç”¢å“åç¨±
  batchSize            Int // æ‰¹æ¬¡å¤§å°
  productionSteps      String    @db.Text // ç”Ÿç”¢æ­¥é©Ÿ (JSON as String)
  qualityControlPoints String    @db.Text // è³ªé‡æ§åˆ¶é» (JSON as String)
  riskAssessment       String?   @db.Text // é¢¨éšªè©•ä¼° (JSON as String)
  isoCompliant         Boolean   @default(true) // ISO åˆè¦
  isoStandard          String    @default("ISO 9001") // ISO æ¨™æº–
  status               String    @default("draft") // ç‹€æ…‹ (draft, approved, in_progress, completed)
  approvedBy           String? // æ‰¹å‡†äºº
  approvedAt           DateTime? // æ‰¹å‡†æ™‚é–“
  generatedAt          DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([orderId])
  @@index([status, generatedAt])
  @@index([orderNumber])
  @@map("work_orders")
}

model QCFile {
  id                 String    @id @default(cuid())
  workOrderId        String // é—œè¯çš„å·¥ä½œå–®ID
  testMethods        String    @db.Text // æ¸¬è©¦æ–¹æ³• (JSON as String)
  acceptanceCriteria String    @db.Text // æ¥å—æ¨™æº– (JSON as String)
  inspectionRecords  String?   @db.Text // æª¢é©—è¨˜éŒ„ (JSON as String)
  isoStandard        String    @default("ISO 9001") // ISO æ¨™æº–
  testResults        String?   @db.Text // æ¸¬è©¦çµæœ (JSON as String)
  inspector          String? // æª¢é©—å“¡
  inspectedAt        DateTime? // æª¢é©—æ™‚é–“
  status             String    @default("pending") // ç‹€æ…‹ (pending, in_progress, completed, failed)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([workOrderId])
  @@index([status, createdAt])
  @@index([inspector])
  @@map("qc_files")
}

model ProductDatabase {
  id               String   @id @default(cuid())
  productName      String // ç”¢å“åç¨±
  category         String? // åˆ†é¡
  formula          String   @db.Text // é…æ–¹ (JSON as String)
  efficacy         String?  @db.Text // åŠŸæ•ˆ (JSON as String)
  safety           String?  @db.Text // å®‰å…¨æ€§ (JSON as String)
  regulatoryStatus String?  @db.Text // æ³•è¦ç‹€æ…‹ (JSON as String)
  version          String   @default("1.0") // ç‰ˆæœ¬
  isActive         Boolean  @default(true)
  tags             String?  @db.Text // æ¨™ç±¤ (JSON as String)
  notes            String?  @db.Text // å‚™è¨»
  createdBy        String? // å‰µå»ºè€…
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([productName])
  @@index([category, isActive])
  @@index([createdBy])
  @@map("product_database")
}

model AdCopy {
  id                  String   @id @default(cuid())
  productId           String? // é—œè¯çš„ç”¢å“ID
  targetMarket        String // ç›®æ¨™å¸‚å ´
  language            String   @default("zh-TW") // èªè¨€
  copyType            String // å»£å‘Šè©é¡å‹ (headline, description, benefit, warning)
  content             String   @db.Text // å»£å‘Šè©å…§å®¹
  regulatoryCompliant Boolean  @default(false) // æ³•è¦åˆè¦
  evidenceBased       Boolean  @default(false) // åŸºæ–¼è­‰æ“š
  aiGenerated         Boolean  @default(true) // AI ç”Ÿæˆ
  version             String   @default("1.0") // ç‰ˆæœ¬
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([productId])
  @@index([targetMarket, language])
  @@index([copyType, isActive])
  @@map("ad_copies")
}

// ===== é…æ–¹åº«ç³»çµ± =====

model RecipeLibrary {
  id          String  @id @default(cuid())
  recipeName  String // é…æ–¹åç¨±
  description String? @db.Text // é…æ–¹æè¿°

  // ä¾†æºè¨Šæ¯ï¼ˆæ”¯æ´å¤šå€‹è¨‚å–®ï¼‰
  sourceOrderIds String @db.Text // JSON: ["order1", "order2"]
  customerName   String // å®¢æˆ¶åç¨±
  productName    String // ç”¢å“åç¨±

  // é…æ–¹å…§å®¹
  ingredients  String @db.Text // JSON: RecipeIngredient[]
  unitWeightMg Float // å–®ç²’ç¸½é‡é‡

  // ğŸ”‘ å»é‡é—œéµï¼šé…æ–¹æŒ‡ç´‹ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰
  recipeFingerprint String @unique // åŸºæ–¼å®¢æˆ¶+ç”¢å“+åŸæ–™çµ„åˆçš„ SHA-256 hash

  // è† å›Šè¦æ ¼
  capsuleColor String? // è† å›Šé¡è‰²
  capsuleSize  String? // è† å›Šå¤§å° (#1, #0, #00)
  capsuleType  String? // è† å›Šé¡å‹

  // åˆ†é¡èˆ‡æ¨™ç±¤
  category String? // åˆ†é¡
  tags     String? @db.Text // JSON: string[]

  // çµ±è¨ˆæ•¸æ“š
  productionCount  Int       @default(1) // ç”Ÿç”¢æ¬¡æ•¸ï¼ˆç›¸åŒé…æ–¹ç”Ÿç”¢äº†å¤šå°‘æ¬¡ï¼‰
  usageCount       Int       @default(0) // å‰µå»ºè¨‚å–®æ¬¡æ•¸ï¼ˆå¾æ­¤é…æ–¹å‰µå»ºäº†å¤šå°‘æ–°è¨‚å–®ï¼‰
  lastUsedAt       DateTime? // æœ€å¾Œä½¿ç”¨æ—¥æœŸï¼ˆç”¨æ–¼å‰µå»ºæ–°è¨‚å–®ï¼‰
  lastProductionAt DateTime? // æœ€å¾Œç”Ÿç”¢æ—¥æœŸ

  // å…ƒæ•¸æ“š
  notes     String?  @db.Text // å‚™è¨»
  isActive  Boolean  @default(true) // æ˜¯å¦å•Ÿç”¨
  createdBy String? // å‰µå»ºè€…
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // AI åŠŸæ•ˆåˆ†æ
  aiEffectsAnalysis String?   @db.Text // AI åˆ†æçš„é…æ–¹åŠŸæ•ˆ
  aiAnalyzedAt      DateTime? // AI åˆ†ææ™‚é–“

  // ğŸ†• é…æ–¹é¡å‹èˆ‡ä¾†æº
  recipeType String @default("production") // "production" | "template"
  sourceType String @default("order") // "order" | "manual" | "batch_import"

  @@index([customerName])
  @@index([productName])
  @@index([recipeName])
  @@index([category, isActive])
  @@index([productionCount])
  @@index([usageCount])
  @@index([createdAt])
  @@index([recipeType])
  @@index([sourceType])
  @@map("recipe_library")
}
